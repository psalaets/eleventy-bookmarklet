const { rollup } = require('rollup');
const resolve = require('@rollup/plugin-node-resolve').default;
const terser = require('@rollup/plugin-terser').default;
const path = require('node:path');

/**
 * @param {string} entryFilePath
 * @returns {Promise<string>} code
 */
module.exports.bundleCode = async function bundleCode(entryFilePath) {
  let bundle = null;

  try {
    bundle = await rollup({
      input: entryFilePath,
      plugins: [resolve()]
    });

    const code = await generateOutput(bundle);

    console.log();
    console.log(`${code.length} characters from ${path.basename(entryFilePath)}:`);
    console.log();
    console.log(code);

    return code;
  } finally {
    if (bundle) {
      await bundle.close();
    }
  }
}

async function generateOutput(bundle) {
  const { output } = await bundle.generate({
    format: 'iife',
    plugins: [
      terser({
        module: true,
        ecma: '2022',
        compress: {
          negate_iife: false,
        }
      })
    ]
  });

  for (const chunkOrAsset of output) {
    if (chunkOrAsset.type === 'chunk') {
      return chunkOrAsset.code;
    }
  }

  console.error('No chunks generated by rollup', output);
  throw new Error('No chunks generated by rollup');
}
